doctype html
head
meta(charset='UTF-8')
meta(http-equiv='X-UA-Compatible' content='IE=edge')
meta(name='viewport' content='width=device-width, initial-scale=1.0')
link(href='https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css' rel='stylesheet')
script(src='https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js')
link(rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css')
link(rel="stylesheet", href="/css/style.css")
script(src='https://cdn.jsdelivr.net/npm/chart.js')


nav.navbar.navbar-icon-top.navbar-expand-lg.navbar-dark.bg-dark
      a.navbar-brand(href='/') ED-Store
      button.navbar-toggler(type='button' data-toggle='collapse' data-target='#navbarSupportedContent' aria-controls='navbarSupportedContent' aria-expanded='false' aria-label='Toggle navigation')
        span.navbar-toggler-icon
      #navbarSupportedContent.collapse.navbar-collapse
        ul.navbar-nav.mr-auto
          li.nav-item.active
            a.nav-link(href='/')
              i.fa.fa-home(style="color:lime")
              | Home

          li.nav-item
            a.nav-link(href='/users/profile')
              i.fa.fa-globe(style="color:lime")
              | Profile



div(id="loading")
  div(id="spinnerDiv")
    div(id="loader")
  

#wrapper.d-flex
  // Sidebar
  #sidebar-wrapper.bg-white
    .sidebar-heading.text-center.py-4.primary-text.fs-4.fw-bold.text-uppercase.border-bottom
      i.fas.fa-user-secret.me-2(style="color:lime")
      | Admin Panel
    .list-group.list-group-flush.my-3
      a.list-group-item.list-group-item-action.bg-transparent.second-text.active(href='#' )
        i.fas.fa-tachometer-alt.me-2(style="color:lime")
        | Dashboard

      a.list-group-item.list-group-item-action.bg-transparent.second-text.fw-bold.active(href='/products' target="_blank")
        i.fas.fa-gift.me-2(style="color:lime")
        | Products
      a.list-group-item.list-group-item-action.bg-transparent.second-text.fw-bold.active(href='/products/create' target="_blank")
        i.fas.fa-gift.me-2(style="color:lime")
        | Add new Products

      a.list-group-item.list-group-item-action.bg-transparent.second-text.fw-bold.active(href='/users/send-info-email' target="_blank")
        i.fas.fa-envelope.me-2(style="color:lime")
        | Send email to users

      a.list-group-item.list-group-item-action.bg-transparent.text-success.fw-bold(href='/users/logout')
        i.fas.fa-power-off.me-2(style="color:lime")
        | Logout
  // /#sidebar-wrapper
  // Page Content
  #page-content-wrapper
    nav.navbar.navbar-expand-lg.navbar-light.bg-transparent.py-4.px-4
      .d-flex.align-items-center
        i#menu-toggle.fas.fa-align-left.primary-text.fs-4.me-3
        h2.fs-2.m-0 Dashboard
      button.navbar-toggler(type='button' data-bs-toggle='collapse' data-bs-target='#navbarSupportedContent' aria-controls='navbarSupportedContent' aria-expanded='false' aria-label='Toggle navigation')
        span.navbar-toggler-icon
      #navbarSupportedContent.collapse.navbar-collapse
        ul.navbar-nav.ms-auto.mb-2.mb-lg-0
          li.nav-item.dropdown
            a#navbarDropdown.nav-link.dropdown-toggle.second-text.fw-bold(href='#' role='button' data-bs-toggle='dropdown' aria-expanded='false')(style="color:black")
              i.fas.fa-user.me-2(style="color:black")
              | #{user.username}
            ul.dropdown-menu(aria-labelledby='navbarDropdown')
              li
                a.dropdown-item(href='/users/profile') Profile

              li
                a.dropdown-item(href='/users/logout') Logout

                
    .container-fluid.px-4
      .row.g-3.my-2
        .col-md-3
          .p-3.bg-white.shadow-sm.d-flex.justify-content-around.align-items-center.rounded
            div
                h3.fs-2 #{allProds}
                p
                  a(href="/products/allProducts" style="text-decoration:none; list-style-type:none; color:black" target="_blank").fs-5  Total products
                //- p.fs-5 Total Products
            i.fas.fa-gift.fs-1.primary-text.border.rounded-full.secondary-bg.p-3
        .col-md-3
          .p-3.bg-white.shadow-sm.d-flex.justify-content-around.align-items-center.rounded
            div
              h3.fs-2 #{allOrders.length}
              p.fs-5 Total Sales
            i.fas.fa-hand-holding-usd.fs-1.primary-text.border.rounded-full.secondary-bg.p-3
        .col-md-3
          .p-3.bg-white.shadow-sm.d-flex.justify-content-around.align-items-center.rounded
            div
              h3.fs-2 #{ordersThisWeek.length}
              p.fs-5 Sales this week
            i.fas.fa-calendar-alt.fs-1.primary-text.border.rounded-full.secondary-bg.p-3
        .col-md-3
          .p-3.bg-white.shadow-sm.d-flex.justify-content-around.align-items-center.rounded
            div
              h3.fs-2 #{todayOrders.length}
              p.fs-5 Sales today
            i.fas.fa-calendar-check.fs-1.primary-text.border.rounded-full.secondary-bg.p-3
        
        .col-md-3
          .p-3.bg-white.shadow-sm.d-flex.justify-content-around.align-items-center.rounded
            div
              h3.fs-2 #{admins.length}
              a(href="/users/allAdmins" style="text-decoration:none; list-style-type:none; color:black" target="_blank").fs-5 View all admin accounts
            i.fas.fa-regular.fa-star.fs-1.primary-text.border.rounded-full.secondary-bg.p-3
        .col-md-3
          .p-3.bg-white.shadow-sm.d-flex.justify-content-around.align-items-center.rounded
            div
              h3.fs-2 #{confirmedOrders.length}
              a(href="/orders/confirmed" style="text-decoration:none; list-style-type:none; color:black" target="_blank").fs-5 Total confirmed Orders
            i.fas.fa-hand-holding-usd.fs-1.primary-text.border.rounded-full.secondary-bg.p-3
        .col-md-3
          .p-3.bg-white.shadow-sm.d-flex.justify-content-around.align-items-center.rounded
            div
              h3.fs-2 #{unconfirmedOrders.length}
              a(href="/orders/unconfirmed" style="text-decoration:none; list-style-type:none; color:black" target="_blank").fs-5 Unconfirmed Orders
            i.fas.fa-hand-holding-usd.fs-1.primary-text.border.rounded-full.secondary-bg.p-3

        .col-md-3
          .p-3.bg-white.shadow-sm.d-flex.justify-content-around.align-items-center.rounded
            div
              h3.fs-2 #{(totalPrice).toFixed(2)}den
              a( style="text-decoration:none; list-style-type:none; color:black").fs-5 Total income from orders
            i.fas.fa-credit-card.fs-1.primary-text.border.rounded-full.secondary-bg.p-3
        .col-md-3
          .p-3.bg-white.shadow-sm.d-flex.justify-content-around.align-items-center.rounded    
            div
              if increase > 0
                h3.fs-2(style="color:lime") #{increase.toFixed(2)}%
                p.fs-5 Sales Increase last 24h  
              if increase < 0
                h3.fs-2(style="color:red") - #{increase.toFixed(2)}%
                p.fs-5 Sales Increase last 24h
            i.fas.fa-chart-bar.fs-1.primary-text.border.rounded-full.secondary-bg.p-3
        if message.length > 0
          h1(class="alert alert-danger") #{message}
      
      
    .container
      .container(style="display:flex; margin: 0 auto; gap:80px")
        div#chart
          canvas#myChart

        div#chart2
          canvas#myChart2
      
      .row.my-5
        h3.fs-4.mb-3 Last 10 orders
        
        a(href="/orders/allOrders" style="font-size:18px; width:30%; display:flex; margin: 0 auto; text-align:center;" class="btn btn-success") View all Orders

        .col
          table.table.bg-white.rounded.shadow-sm.table-hover
            thead

                tr
                  th(scope='col' width='50') Order ID
                  th(scope='col') Product ID
                  th(scope='col') Customers Name
                  th(scope='col') Customers Email
                  th(scope='col') Customers Phone
                  th(scope='col') Customers Address
                  th(scope='col') Customers City
                  th(scope='col') Total Price
                  th(scope='col') Status
                  th(scope='col') Manage

            tbody
              each order in allOrders
                tr
                  th(scope='row' class="badge bg-success" style="font-size:10px") #{order._id}
                  td 
                    a(href="/products/"+order.productID target="_blank" ) #{order.productID}
                  
                  td #{order.customerName}
                  td 
                    a(href="mailto:"+order.customerEmail) #{order.customerEmail}
                  td #{order.customerPhone}
                  td #{order.customerAddress}
                  td #{order.customerCity}
                  if order.discount
                    td #{parseFloat(order.productPrice * order.quantity - ( order.productPrice * order.quantity * order.discount / 100)).toFixed(2) } den 
        
                  else 
                    td #{parseFloat(order.productPrice)} den
                  //- #{order.productPrice * 61.5} den 
                  if order.status == false
                    td(style="color:red") Pending
                  if order.status == true
                    td(style="color:green") Confirmed
                  td  
                    if order.status == true
                      form(action="/admin/unconfirm/"+order._id, method='post') 
                        button(class="btn btn-danger" ) Cancel 
                      i.fas.fa-exclamation-triangle
                      
                    if order.status == false
                      form(action="/admin/"+order._id, method='post') 
                        input(type="number" placeholder="ETA" name="eta" class="form-control")
                        br
                        button(class="btn btn-success" type="submit") Confirm
                      i.fa.fa-check(style="color:lime")
                      form(action="/orders/delete/"+order._id, method='post') 
                        button(class="btn btn-danger" type="submit") Cancel


    

script.
  window.onload = () => {
    let isLoading = true;
    document.getElementById('loader').innerHTML = "LOADING...";
    
    

  const orders2022 = 'http://localhost:3000/orders/orders2022';
  const orders2023 = 'http://localhost:3000/orders/orders2023';
  const earnings2022 = 'http://localhost:3000/orders/earnings2022';
  const earnings2023 = 'http://localhost:3000/orders/earnings2023';
  const earningsLastMonth = 'http://localhost:3000/orders/last-month-earnings';


  async function getProducts() {

    //orders 2022
    const response2022 = await fetch(orders2022);
    allOrders2022 = await response2022.json();
    console.table({allOrders2022})
    const data2022 = allOrders2022.length;
    console.table({data2022})

    //orders 2023
    const response2023 = await fetch(orders2023);
    allOrders2023 = await response2023.json();
    console.log({allOrders2023})
    const data2023 = allOrders2023.length;
    console.log({data2023})
 
    //earnings from orders 2022
    const earningsresponse2022 = await fetch(earnings2022);
    let totalearnings2022 = await earningsresponse2022.json();
    console.log({totalearnings2022})

    //earnings from orders 2022
    const earningsresponse2023 = await fetch(earnings2023);
    let totalearnings2023 = await earningsresponse2023.json();
    console.log({totalearnings2023})

    // earnings last month
    const earningsresponseLastMonth = await fetch(earningsLastMonth);
    let totalEarningsLastMonth = await earningsresponseLastMonth.json();
    console.log({totalEarningsLastMonth})


    //ORDERS CHART
    const ctx = document.getElementById('myChart');
    new Chart(ctx, {
    type: 'pie',
    data: {
    labels: ["Total orders in 2022", "Total orders in 2023"],
    datasets: [{
    label: 'Total',
    data: [data2022,data2023],
    borderWidth: 2
    }]
    },
    options: {
    scales: {
    y: {
    beginAtZero: true
    }
    }
    }
    });

    // EARNINGS CHART
    const ctx2 = document.getElementById('myChart2');
    new Chart(ctx2, {
    type: 'bar',
    data: {
    //- labels: ["Total earnings (MKD) in 2022", "Total earnings (MKD) in 2023"],
    labels: ["Total earnings (MKD) in 2022", "Total earnings (MKD) in 2023", "Total earnings (MKD) last 30 days"],
    datasets: [{
    label: 'Earnings in MKD',
    data: [totalearnings2022,totalearnings2023,totalEarningsLastMonth],
     backgroundColor: [
      'rgba(255, 205, 86, 0.5)',
      'rgba(153, 102, 255, 0.5)',
      'rgba(255, 0, 0 , 0.5)',

    ],
    borderWidth: 2
    }]
    },
    options: {
    scales: {
    y: {
    beginAtZero: true
    }
    }
    }
    });

    isLoading=false;
    console.log({isLoading})
    //- var image = document.getElementById('spinner').src = "";


    document.getElementById('loader').innerHTML = "";
    document.getElementById('spinnerDiv').style.display='none';
  }
  getProducts();


  }
  

// /#page-content-wrapper
script(src='https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js')
script.
  var el = document.getElementById("wrapper");
  var toggleButton = document.getElementById("menu-toggle");
  toggleButton.onclick = function () {
  el.classList.toggle("toggled");
  };

